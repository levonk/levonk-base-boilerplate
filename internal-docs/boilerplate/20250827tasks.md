# 2025-08-27 Task List — Ansible Layered Development Template

Note: Tasks are derived from the current state of `README.md` and `internal-docs/boilerplate/base-boilerplate.md`. No existing features are to be removed; implement missing pieces and align docs/config accordingly.

## 0) Repository Hygiene and Alignment

- [x] Ensure license alignment: `README.md` declares `AGPL-3.0-or-later`; update root `LICENSE` to match if needed. (Verified `LICENSE` is AGPL-3.0 text; aligned)
- [x] Update `.gitignore` to include required ignores (if missing): `.local/`, `.envs/`, `node_modules/`, `__pycache__/`, `.venv/`, `.idea/`, `.DS_Store`. (Updated generator to read `.config/filelists/`; added `.envs/` to `security.ignorefile`; regenerated)
- [x] Align docs references to use `.local/worktrees/` (replace any lingering `.worktrees/` mentions), e.g. in `README.md` "Understanding the Project Structure". (Updated `README.md`) (Invalidated by 2025-08-28 peer worktree decision)
- [x] Add basic contributor guidance in `README.md` for running scripts, generating agents, and expected environment. (Added "Contributor Quickstart" section)

- [x] Template the output directory structure exactly as specified in "Template Structure (Generated Output)" (apps, libs, tools, scripts, ansible, .devcontainer, docker-compose.yml, .mise.toml, nx configs, `.envs/`). (Added placeholders: `apps/.gitkeep`, `libs/.gitkeep`, `scripts/{setup_container.sh,setup_development.sh,launch.sh}`, `ansible/{requirements.yml,build_time.yml,runtime.yml}`; `.devcontainer/*`, `docker-compose.yml`, `.mise.toml` templated via `.j2`.)
- [x] Add Copier post-copy hooks (optional) to initialize git, initial commit if `initial_commit` is true, and create worktrees/feature branches if `create_feature_branches` is true. (Added `_tasks` in `.copier.yml` for git init, optional commit, and worktree/branch creation.)

## 2) Dev Container Setup (`.devcontainer/`)

- [ ] Create `.devcontainer/devcontainer.json` with:
  - [x] Container build using `Dockerfile.run` (multi-stage base/build/run).
  - [x] Recommended extensions: Nx Console, Docker, YAML, Ansible, Markdown lint.
  - [x] Settings: Remote user, shell, auto-forwarded ports if applicable.
  - [x] Mount package caches when `container_share_package_cache` is true.
  - [x] Note: Jinja template added at `.devcontainer/devcontainer.json.j2`; repo holds minimal placeholder for linting.
  - [x] Additional: forwardPorts and postCreate/postStart commands added.
- [ ] Create `.devcontainer/Dockerfile.base`:
  - [x] FROM `${agent_os_repository}:${agent_os_tag}` or equivalent.
  - [x] Install `git` (and minimal required tools).
  - [ ] Create `${container_user}` and `${container_group}` with `${container_user_id}:${container_group_id}`; set permissions and `USER`.
  - [x] Note: Jinja template added at `.devcontainer/Dockerfile.base.j2`; repo holds minimal placeholder for linting.
- [ ] Create `.devcontainer/Dockerfile.build`:
  - [x] FROM base image.
  - [x] Install Ansible; copy `ansible/` content.
  - [x] `ansible-galaxy install -r ansible/requirements.yml` (if present).
  - [x] `ansible-playbook ansible/build_time.yml`.
  - [x] Note: Jinja template added at `.devcontainer/Dockerfile.build.j2`; repo holds minimal placeholder for linting.
- [ ] Create `.devcontainer/Dockerfile.run`:
  - [x] FROM build image.
  - [ ] Copy application (template outputs).
  - [x] Configure environment for `mise` activation (profile scripts).
  - [x] CMD to `/scripts/setup_development.sh`.
  - [x] Note: Jinja template added at `.devcontainer/Dockerfile.run.j2`; repo holds minimal placeholder for linting.

## 3) Docker Compose

- [ ] Implement `docker-compose.yml` with dynamic services based on `number_of_worktrees` (controller + agents):
  - [x] Mount project workspace. (Previously mounted `.local/worktrees/` — invalidated by peer worktree scheme)
  - [x] Set `user: ${container_user_id}:${container_group_id}` in services.
  - [x] Use per-agent env files `.envs/agentX/.env`.
  - [x] Port mapping logic driven by `base_ide_port`, `agent_ide_port_increment`, `num_ide_ports`.
  - [x] Example app port pattern (from README): support `AGENT_PORT` via envs and map `"${AGENT_PORT}:${AGENT_PORT}"` when defined. (Added commented example in `docker-compose.yml.j2`.)
  - [x] Conditional service for `separate_test_container`.
  - [x] Healthchecks placeholders for services. (Added basic `CMD-SHELL` echo healthchecks for controller, agents, and tests.)
  - [x] Note: Jinja template added at `docker-compose.yml.j2` implementing dynamic agents, mounts, users, env files, and IDE port logic. Repo holds minimal placeholder `docker-compose.yml` for linting.

## 4) Scripts (`scripts/`)

- [ ] `scripts/setup_container.sh`:
  - [x] Install `mise` and configure shims in PATH.
  - [x] Install project deps per `project_type` and `project_dependencies` (bun/uv preferred; fallbacks via official installers).
  - [x] Install and run Ansible roles from `container_setup_ansible_roles` (if any).
- [ ] `scripts/setup_development.sh`:
  - [x] Clone/apply `dotfiles_repository` into `dotfiles_destination` when `project_type == "dotfiles"`.
  - [x] Install and run `development_runtime_ansible_roles`.
  - [x] Generate `.envs/agentX/.env` files if missing; seed app-specific variables and comments.
- [ ] `scripts/launch.sh`:
  - [x] Generate/update `.envs/` per agent.
  - [x] Start `docker-compose` stack.
  - [x] Launch Zellij with the provided `zellij_layout`.

## 5) Ansible (`ansible/`)

- [x] `ansible/requirements.yml` with roles referenced by build-time and runtime tasks.
- [x] `ansible/build_time.yml` for image provisioning steps (idempotent).
- [x] `ansible/runtime.yml` for runtime configuration steps (idempotent).

## 6) Nx Monorepo Scaffolding

- [ ] Initialize Nx workspace per `nx_preset` (npm/yarn/pnpm) and set `nx_default_base`.
- [ ] Add `package.json`, lockfile, `nx.json`, base tsconfig if needed.
- [ ] Create example projects:
  - [ ] `apps/controller/` with minimal code (e.g., `src/main.py` or TS app depending on preset).
  - [ ] `apps/agent1/` with minimal code (e.g., `src/agent.py` or TS lib as per preset).
  - [ ] `libs/utils/` shared library with example export.
- [ ] Testing:
  - [ ] Configure Jest (as referenced by README) for JS/TS projects; if Python, add pytest alternative or document split.
  - [ ] Add sample unit tests for controller, agent, and utils.
- [ ] Tools:
  - [ ] `tools/generators/agent/` (if `nx_cli_extension`): `generator.ts`, `schema.json`, `files/` template.
  - [ ] Wire generator into workspace (local plugin or package.json).
  - [ ] Optional executors: `tools/executors/container/` to wrap `docker compose`/`zellij` tasks.

## 7) Mise (`.mise.toml`)

- [x] Generate `.mise.toml` from `mise_languages` (when provided) and verify activation in container shells.
  - [x] Note: Jinja template added at `.mise.toml.j2`; repo holds minimal placeholder for linting. Verification in container shells pending.

## 8) Zellij Integration

- [x] Accept `zellij_layout` input; write layout file to repo (e.g., `.zellij/layout.kdl`).
- [x] `launch.sh` opens the layout and names panes for each agent/container.

## 9) Git Worktrees

- [x] Use `.local/worktrees/` for local worktrees (not committed). (Invalidated by 2025-08-28 decision to use peer directories)
- [x] Script worktree creation: generate `worktree_prefix`-based folders count = `number_of_worktrees`. (Invalidated)
- [x] If `create_feature_branches` is true, create branches per worktree and set upstream as needed. (Still valid)

### 9.a) New scheme: Peer worktrees (2025-08-28)

- [x] Define worktree location as peer directories to the main repo to avoid IDE/AI crawling confusion.
  - Example: if repo dir is `project-alpha`, then worktrees are `project-alpha-01`, `project-alpha-02`, ... up to `number_of_worktrees`.
  - Keep branch names as `{{ worktree_prefix }}-<i>` (unchanged) unless otherwise configured.
- [x] Update `scripts/worktrees.sh.j2` to create worktrees at `../<repo-name>-NN` (zero-padded) instead of `.local/worktrees/...`.
- [x] Update Copier `_tasks` in `.copier.yml` to follow peer-directory worktree creation.
- [x] Add safeguards and idempotency checks: re-use existing branches and worktrees if present.
- [x] Document cleanup steps for removing peer worktrees safely. (See `internal-docs/boilerplate/base-boilerplate.md` § "X. Removing Peer Worktrees Safely")

### 9.b) Follow-up docs/templates

- [x] Update `README.md` to reflect peer worktree scheme and rationale.
- [x] Update any mounts or references in templates (e.g., `docker-compose.yml.j2`) that previously referenced `.local/worktrees/` (if any) to avoid stale guidance.

## 10) IDE Support

- [x] `ide_support == "vscode"`: ensure devcontainer includes necessary tooling and recommended extensions.
- [ ] `ide_support == "intellij"`: add docs/instructions for remote dev or container attach.
- [ ] `ide_support == "none"`: ensure stack runs headless; keep docs updated.

## 11) Environment and Ports

- [x] Create `.envs/agentX/.env` templates including IDE ports and optional `AGENT_PORT` example.
- [x] Document how `base_ide_port`, `agent_ide_port_increment`, and `num_ide_ports` compute actual mappings.

## 12) Security and Compliance

- [x] Run containers as non-root with minimal capabilities; consider user namespaces.
- [x] Add `hadolint` config and CI step for Dockerfiles.
- [x] Add `shellcheck` for scripts in CI.
- [ ] Optional: Add `trivy`/`grype` image scan in CI.
- [ ] Document secrets management strategy for local dev (e.g., `.env`, not committed) and production (out of scope but referenced).
- [ ] // TODO: Compliance — add placeholders/tests per org requirements.

## 13) CI/CD

- [x] GH Actions workflow for CI: lint (markdownlint, eslint if applicable, shellcheck, hadolint), build, and tests (Nx).
- [ ] Cache dependencies (npm/pnpm/yarn) and Nx cache.
- [ ] Optional: Build container images for PRs if desired.

## 14) Documentation Refinement

- [ ] Sync `README.md` with final structure (e.g., peer worktrees `repo-01`, `repo-02`, `.envs/`, scripts usage, Nx/Jest notes).
- [ ] Add quickstart for Copier: example `copier copy` invocation, variables table, and common overrides.
- [ ] Add troubleshooting section for Docker, permissions, ports, and zellij.

## 15) Internal Docs and BDD (Optional but recommended)

- [ ] Add BDD feature scaffolding under `internal-docs/features/...` with initial Gherkin for generator and launch workflows.
- [ ] Record AI interactions and decisions per internal guidelines (`./internal-docs/ai/prompts/...`).
