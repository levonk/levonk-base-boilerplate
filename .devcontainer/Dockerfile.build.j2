{% if use_devcontainer %}
# Build-time provisioning image
FROM {{ agent_os_repository }}:{{ agent_os_tag }} as build

USER root
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
       python3 python3-pip ansible git curl ca-certificates bash \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /workspace
# Copy Ansible assets if present
COPY ansible/ ./ansible/
# Install roles and run build-time playbook if provided
RUN bash -lc 'mkdir -p /workspace/.artifacts && echo "placeholder" > /workspace/.artifacts/.keep'
RUN bash -lc 'if [ -f ansible/requirements.yml ]; then ansible-galaxy install -r ansible/requirements.yml; fi'
RUN bash -lc 'if [ -f ansible/build_time.yml ]; then ansible-playbook ansible/build_time.yml -i localhost, --connection=local; fi'

# Base stage (optional reference)
FROM {{ agent_os_repository }}:{{ agent_os_tag }} as base

ARG USER={{ container_user }}
ARG GROUP={{ container_group }}
ARG UID={{ container_user_id }}
ARG GID={{ container_group_id }}

RUN groupadd -g ${GID} ${GROUP} \
    && useradd -m -s /bin/bash -u ${UID} -g ${GID} ${USER}

USER ${USER}
WORKDIR /home/${USER}
{% endif %}
